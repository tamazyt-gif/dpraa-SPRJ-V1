<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>dpraa SPRJ-V1</title>
<style>
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin: 0; 
  padding: 2em; 
  background: #c0d8f8; 
  color: #333; 
  display: flex; 
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-y: auto;  
  position: relative;
  scroll-behavior: smooth;
}

/* Background animated waves */
body::before, body::after {
  content: "";
  position: absolute;
  width: 200%;
  height: 200%;
  top: -50%;
  left: -50%;
  background: radial-gradient(circle at center, #c0d8f8 0%, #e1edfc 100%);
  opacity: 0.6;
  border-radius: 45%;
  animation: waveMove 30s linear infinite;
  z-index: -1;
}
body::after {
  animation-duration: 45s;
  opacity: 0.4;
  border-radius: 50%;
}
@keyframes waveMove {
  0% { transform: rotate(0deg) translate(0,0); }
  50% { transform: rotate(180deg) translate(50px,50px); }
  100% { transform: rotate(360deg) translate(0,0); }
}

h1 { 
  color: #2c3e50; 
  text-align: center; 
  width: 100%; 
  margin-bottom: 0.2em; 
}

.sponsored {
  text-align: center;
  margin-top: -0.2em;
  margin-bottom: 1.5em;
  font-size: 14px;
  font-style: italic;
  color: rgba(0,0,0,0.5);
}

.form-container { 
  width: 100%;
  max-width: 600px; 
  margin: 2em 0; 
  background: rgba(255,255,255,0.55);
  backdrop-filter: blur(14px);
  padding: 2em; 
  border-radius: 16px; 
  box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
  border: 1px solid rgba(255,255,255,0.6);
  position: relative;
  z-index: 1;
}

label { display: block; margin-top: 1em; font-weight: bold; color: #34495e; }

input[type="text"] { 
  width: 100%; 
  padding: 0.7em; 
  font-size: 1em; 
  margin-top: 0.5em; 
  box-sizing: border-box; 
  border: 1px solid #bdc3c7; 
  border-radius: 8px; 
  background: rgba(255,255,255,0.65);
  backdrop-filter: blur(8px);
}

button { 
  margin-top: 1.5em; 
  width: 100%; 
  padding: 0.8em; 
  font-size: 1em; 
  cursor: pointer; 
  color: white; 
  border: none; 
  border-radius: 12px;
  font-weight: bold;
  background: linear-gradient(-45deg, #2961ac, #23407c);
  background-size: 400% 400%;
  animation: gradientAnimation 5s ease infinite;
  box-shadow: 0 0 12px rgba(33, 64, 124, 0.8), 0 0 25px rgba(41, 97, 172, 0.6) inset;
  transition: transform 0.3s, box-shadow 0.3s;
}
button:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(33, 64, 124, 1), 0 0 35px rgba(41, 97, 172, 0.8) inset; }

@keyframes gradientAnimation { 
  0% { background-position: 0% 50%; } 
  50% { background-position: 100% 50%; } 
  100% { background-position: 0% 50%; } 
}

#result { 
  margin-top: 2em; 
  background: rgba(255,255,255,0.55); 
  padding: 1em; 
  border-radius: 12px; 
  box-shadow: 0 6px 20px rgba(0,0,0,0.12); 
  overflow-x: auto; 
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 1;
}

table { width: 100%; border-collapse: collapse; margin-top: 1em; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: rgba(236, 240, 241, 0.7); font-weight: bold; position: sticky; top: 0; backdrop-filter: blur(8px); }

.status-missing-agent { background-color: #ffebee; }
.status-missing-doc { background-color: #fff9c4; }
.status-nominal-tidak-cocok { background-color: #ffccbc; }
.status-matched-by-name { background-color: #e1f5fe; }

.loading { display: none; text-align: center; margin-top: 1em; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.notification { padding: 1em; margin-top: 1em; border-radius: 4px; font-weight: bold; }
.notification.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.notification.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

#backToTop {
  position: fixed; bottom: 40px; right: 40px;
  padding: 0.8em 1em; font-size: 1em; border: none; border-radius: 50px;
  background: #23407c; color: #fff; cursor: pointer;
  display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10;
  transition: background 0.3s;
}
#backToTop:hover { background: #2961ac; }
</style>
</head>
<body>

<h1>dpraa SPRJ-V1</h1>
<p class="sponsored">Sponsored by DYP Ltd. Co.</p>

<div class="form-container">
  <label for="token">Token Rahasia:</label>
  <input type="text" id="token" placeholder="Masukkan token rahasia" />
  <label for="sheetId">ID Spreadsheet:</label>
  <input type="text" id="sheetId" placeholder="Masukkan ID spreadsheet" />
  <button id="submitBtn">Kirim dan Proses Data</button>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memproses data... Mohon tunggu.</p>
  </div>
</div>

<div id="result"></div>
<button id="backToTop" title="Kembali ke atas">â†‘</button>

<script>
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.querySelector('.form-container').appendChild(notification);
  setTimeout(() => notification.remove(), 5000);
}

function formatNumber(value) {
  const num = Number(value);
  if (isNaN(num)) return value;
  return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
}

document.getElementById('submitBtn').addEventListener('click', async () => {
  const token = document.getElementById('token').value.trim();
  const sheetId = document.getElementById('sheetId').value.trim();
  const resultDiv = document.getElementById('result');
  const loadingDiv = document.getElementById('loading');
  resultDiv.innerHTML = '';

  if (!token) { showNotification('Token wajib diisi!', 'error'); return; }
  if (!sheetId) { showNotification('ID Spreadsheet wajib diisi!', 'error'); return; }

  loadingDiv.style.display = 'block';

  try {
    const url = `https://script.google.com/macros/s/AKfycbz9-_Zd0aIOIK6ntxrpCNsKXtmpg4e32vR-rByy0yzZ-WdB4QOCnk6lRmV7t-waitYB5A/exec?token=${encodeURIComponent(token)}&sheetId=${encodeURIComponent(sheetId)}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

    const data = await response.json();
    loadingDiv.style.display = 'none';

    if (data.error) {
      showNotification(`Terjadi kesalahan: ${data.error}`, 'error');
      return;
    }

    if (!Array.isArray(data.results) || data.results.length === 0) {
      resultDiv.innerHTML = '<div class="notification success">Tidak ada data bermasalah. Semua data cocok.</div>';
      return;
    }

    const table = document.createElement('table');
    const headers = ["Rek AGENT","Rek DOC","User AGENT","User DOC","Nominal AGENT","Nominal DOC","STATUS","Catatan","Detail"];
    const headerRow = document.createElement('tr');
    headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th); });
    table.appendChild(headerRow);

    data.results.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach((cell, index) => {
        const td = document.createElement('td');
        td.textContent = (index === 4 || index === 5) ? formatNumber(cell) : cell || '';
        tr.appendChild(td);
      });

      const status = row[6] || '';
      const catatanTd = tr.children[7];

      // Tampilkan tanggalApprove jika status NOMINAL TIDAK COCOK DI AGENT
      if(status.includes("NOMINAL TIDAK COCOK DI AGENT")) {
        catatanTd.textContent = row[7] || '';
      }

      if(status.includes("TIDAK ADA DI DOC")) tr.classList.add('status-missing-agent');
      else if(status.includes("USERNAME TIDAK DITEMUKAN DI AGENT")) tr.classList.add('status-missing-doc');
      else if(status.includes("NOMINAL TIDAK COCOK (COCOK BERDASARKAN NAMA)")) tr.classList.add('status-matched-by-name');
      else if(status.includes("NOMINAL TIDAK COCOK")) tr.classList.add('status-nominal-tidak-cocok');

      table.appendChild(tr);
    });

    resultDiv.appendChild(table);
    showNotification(`Ditemukan ${data.results.length} data bermasalah.`, 'error');

  } catch(err) {
    loadingDiv.style.display = 'none';
    showNotification(`Terjadi kesalahan: ${err.message}`, 'error');
  }
});

// Back to Top Button
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  backToTopBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
});
backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
</script>
</body>
</html>
