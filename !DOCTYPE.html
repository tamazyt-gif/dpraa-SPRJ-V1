<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dpraa SPRJ-V1</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* (Gaya CSS tetap seperti yang kamu kirim ‚Äî tidak diubah) */
    /* ... [CSS tidak disalin ulang agar singkat ‚Äî sama dengan yang kamu kirim] ... */
  </style>
</head>
<body>

<h1>dpraa SPRJ-V1</h1>
<p class="sponsored">Sponsored by DYP Ltd. Co.</p>

<div class="form-container">
  <!-- üîê Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="86696926016-2vqc0lp56opcdo4rdm86ptkp46o74dsk.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false"></div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left"></div>

  <label for="token">Token Rahasia:</label>
  <input type="text" id="token" placeholder="Masukkan token rahasia" />

  <label for="sheetId">ID Spreadsheet:</label>
  <input type="text" id="sheetId" placeholder="Masukkan ID spreadsheet" />

  <button id="submitBtn">Kirim dan Proses Data</button>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memproses data... Mohon tunggu.</p>
  </div>
</div>

<div id="result"></div>
<button id="backToTop" title="Kembali ke atas">‚Üë</button>

<script>
  let currentIdToken = "";

  function handleCredentialResponse(response) {
    currentIdToken = response.credential;
    showNotification("‚úÖ Login berhasil! Anda sekarang bisa memproses data.", "success");
    document.querySelector('.g_id_signin').style.display = 'none';
  }

  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.querySelector('.form-container').appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
  }

  function formatNumber(value) {
    const num = Number(value);
    if (isNaN(num)) return value;
    return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
  }

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    const sheetId = document.getElementById('sheetId').value.trim();
    const resultDiv = document.getElementById('result');
    const loadingDiv = document.getElementById('loading');
    resultDiv.innerHTML = '';

    if (!currentIdToken) {
      showNotification("Silakan login dengan akun Google terlebih dahulu.", "error");
      return;
    }
    if (!token) {
      showNotification('Token wajib diisi!', 'error');
      return;
    }
    if (!sheetId) {
      showNotification('ID Spreadsheet wajib diisi!', 'error');
      return;
    }

    loadingDiv.style.display = 'block';

    try {
      const url = `https://script.google.com/macros/s/AKfycbxlQaYsvzIldte9WuReQ_uiNh31zjro2w3C99hiNWTmNJBGTUqL6-wB3sHLYmcwVLvCjA/exec?token=${encodeURIComponent(token)}&sheetId=${encodeURIComponent(sheetId)}&idtoken=${encodeURIComponent(currentIdToken)}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

      const data = await response.json();
      loadingDiv.style.display = 'none';

      if (data.error) {
        showNotification(`‚ùå Akses ditolak: ${data.error}`, 'error');
        return;
      }

      if (!Array.isArray(data.results) || data.results.length === 0) {
        resultDiv.innerHTML = '<div class="notification success">Tidak ada data bermasalah. Semua data cocok.</div>';
        return;
      }

      const table = document.createElement('table');
      const headers = ["Rek AGENT", "Rek DOC", "User AGENT", "User DOC", "Nominal AGENT", "Nominal DOC", "STATUS", "Catatan", "Detail"];
      const headerRow = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      data.results.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
          const td = document.createElement('td');
          td.textContent = (index === 4 || index === 5) ? formatNumber(cell) : cell || '';
          tr.appendChild(td);
        });

        const status = row[6] || '';
        const catatanTd = tr.children[7];
        if (status.includes("NOMINAL TIDAK COCOK DI AGENT")) {
          catatanTd.textContent = row[7] || '';
        }

        if (status.includes("TIDAK ADA DI DOC")) tr.classList.add('status-missing-agent');
        else if (status.includes("USERNAME TIDAK DITEMUKAN DI AGENT")) tr.classList.add('status-missing-doc');
        else if (status.includes("NOMINAL TIDAK COCOK (COCOK BERDASARKAN NAMA)")) tr.classList.add('status-matched-by-name');
        else if (status.includes("NOMINAL TIDAK COCOK")) tr.classList.add('status-nominal-tidak-cocok');

        table.appendChild(tr);
      });

      resultDiv.appendChild(table);
      showNotification(`‚ö†Ô∏è Ditemukan ${data.results.length} data bermasalah.`, 'error');

    } catch (err) {
      loadingDiv.style.display = 'none';
      showNotification(`‚ùå Terjadi kesalahan: ${err.message}`, 'error');
    }
  });

  // Tombol back to top
  const backToTopBtn = document.getElementById('backToTop');
  window.addEventListener('scroll', () => {
    backToTopBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
  });
  backToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>

</body>
</html>
